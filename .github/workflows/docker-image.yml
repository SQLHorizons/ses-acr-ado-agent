name: Docker Image CI

on:
  push:
    branches: [ imagebuild ]

jobs:

  build_and_scan:
    name: Build and Scan

    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v2

    - name: Set the Docker image tag
      id: tag
      run: echo ::set-output name=IMAGE_TAG::$(cat version.txt)

    - name: Build the Docker image
      run: |
        docker build \
          --file Dockerfile \
          --tag           ado.pwsh.agent:${{ steps.tag.outputs.IMAGE_TAG }} \
          --build-arg     FROM_TAG=7.1.4-ubuntu-20.04 \
          --build-arg     PWSH_CORE_REPO=mcr.microsoft.com/powershell \
          --build-arg     PESTER_VERSION=5.3.0 \
          --build-arg     ANALYZER_VERSION=1.20.0 \
          --build-arg     AZP_AGENT_VERSION=2.191.1 \
          --no-cache .

    - name: Scan the Docker image
      uses: Azure/container-scan@v0
      with:
        image-name: ado.pwsh.agent:${{ steps.tag.outputs.IMAGE_TAG }}
